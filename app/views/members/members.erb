
<%= partial :'groups/nav', locals: {group: @group, membership: @membership} %>

<div class="mb-3">

  <% form_tag '', :class => 'form-inline', :style => 'display:inline', :method => 'get' do %>
    <%= text_field_tag :q, :class => 'form-control mr-1', :style => 'width: auto; display: inline-block', :placeholder => 'Search members', :value => params[:q] %>
    View as
    <%= select_tag :view, :class => 'form-control mr-1', :options => %w{details pictures dietary_requirements map emails}.map { |view| [view.to_s.humanize.capitalize,view] }, :selected => params[:view], :onchange => 'this.form.submit()' %>        

    <div class="mt-3 mb-1" style="font-size: 13px;">

      <% @group.radio_scopes.each_with_index { |el,i| k,v,t,r = *el %>
        <div class="radio-inline ml-3 mb-2">
          <%= radio_button_tag k, :value => v, :checked => (params[k] == v.to_s), :onclick => 'this.form.submit()', :id => "#{k}-#{v}" %>
          <label for="<%=k%>-<%=v%>">
            <%=t%>&nbsp;<strong><%=r.count%></strong> 
          </label>
        </div>
      <% } %>      

      <% @group.check_box_scopes.each_with_index { |el,i| k,t,r = *el %>
        <div class="checkbox-inline ml-3 mb-2">
          <%= check_box_tag k, :value => true, :checked => params[k], :onclick => 'this.form.submit()', :id => k %>
          <label for="<%=k%>">
            <%=t%>&nbsp;<strong><%=r.count%></strong>
          </label>
        </div>        
      <% } %>
    </div>

  <% end %>

  <% if admin? || @membership.admin? %>

    <a class="btn btn-outline-primary" href="<%=request.path%>.csv?<%=request.query_string%>">Download results as CSV</a>            

    <% if !@group.member_limit or @group.memberships.count < @group.member_limit %>


      <script>
        $(function () {
          var accounts = <%=(current_account.network.where(:id.nin => @group.members.pluck(:id))).map { |account| {:name => account.name, :email => account.email} }.to_json%>
          $('#add-member input[name=name]').typeahead({
            source: accounts,
            afterSelect: function (selected) {
              $('#add-member input[name=email]').val(selected.email)
            }
          });
        })
      </script>


      <a class="btn btn-primary" href="javascript:;" onclick="$(this).hide().next().show().find('input[name=name]').focus()">
        <i class="fa fa-plus-circle"></i> Add member
      </a>

      <div style="display:none" id="add-member" class="my-3">
        <% form_tag "/a/#{@group.slug}/add_member", :class => 'form-inline' do %>
          <%= text_field_tag :name, :class => 'form-control mr-1', :placeholder => 'Name', :autocomplete => 'off' %>
          <%= email_field_tag :email, :class => 'form-control mr-1', :placeholder => 'Email' %>
          <label class="d-inline mr-1">Don't notify group members <%= check_box_tag :prevent_notifications %></label>
          <%= submit_tag 'Add member', :class => 'btn btn-primary' %>
        <% end %>
      </div>

    <% end %> 

  <% end %> 

</div>

<% case (params[:view] || 'details'); when 'pictures' %>

  <div style="margin-top: 15px" class="row no-gutters">
    <% (Account.where(:id.in => @memberships.pluck(:account_id)).where(:picture_uid.ne => nil).shuffle + Account.where(:id.in => @memberships.pluck(:account_id)).where(:picture_uid => nil).shuffle).each { |account| %>
      <%= partial :'accounts/picture', :locals => {:account => account} %>
    <% } %>
  </div>

<% when 'emails' %>

  <pre style="margin-top: 15px;"><%= Account.where(:id.in => @memberships.pluck(:account_id)).map do |account| "#{account.name} &lt;#{account.email}&gt;" end.join(', ') %></pre>

<% when 'dietary_requirements' %>  

  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width: 1px">Name</th>              
        <th>Dietary requirements</th>
      </tr>
    </thead>
    <% @memberships.where(:account_id.in => Account.where(:dietary_requirements.ne => nil).pluck(:id)).each { |membership| account = membership.account %>
      <tr>
        <td>
          <%= partial :'accounts/account', :object => account, :locals => {:membership => membership} %>
          <div>
            <% membership.teamships.each { |teamship| %>
              <a href="/a/<%=@group.slug%>/teams"><span class="label label-primary"><%=teamship.team.name%></span></a>
            <% } %>        
          </div>
        </td>
        <td>
          <%= account.dietary_requirements %>
        </td> 
      </tr>
    <% } %>
  </table>    

<% when 'map' %>

  <%= partial :'maps/map', :locals => {:points => Account.where(:id.in => @memberships.pluck(:account_id))} %>

<% when 'details'; @memberships = @memberships.per_page(10).page(params[:page]) %>

  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width: 1px">Name</th>      
        <th>Following</th>        
        <th>Proposed by</th>
        <th>Accepted at</th>
        <% if @group.democratic_threshold %>
          <th>Suggested magic number</th>
        <% end %>        
        <% if @group.enable_tiers %>
          <th>Tier</th>
        <% end %>
        <% if @group.enable_accommodation %>
          <th>Accommodation</th>
        <% end %>
        <% if @group.enable_transport %>
          <th>Transport</th>
        <% end %>
        <% if @group.enable_budget %>
          <th>Requested contribution</th>
          <th>Paid</th>     
        <% end %>
        <% if @group.facebook_group_url %>
          <th>Member of Facebook group</th>    
        <% end %>
        <% if admin? || @membership.admin %>
          <th></th>
        <% end %>           
      </tr>
    </thead>
    <% @memberships.each { |membership| account = membership.account %>
      <tr data-pagelet-url="/membership_row/<%=membership.id%>">
        <%= partial :'members/membership_row', :locals => {:membership => membership}  %>
      </tr>
    <% } %>
    <tr>     
      <th style="width: 1px"></th>      
      <th></th>
      <th></th>
      <th></th>
      <% if @group.democratic_threshold %>
        <th></th>
      <% end %>        
      <% if @group.enable_tiers %>
        <th></th>
      <% end %>
      <% if @group.enable_accommodation %>
        <th></th>
      <% end %>
      <% if @group.enable_transport %>
        <th></th>
      <% end %>
      <% if @group.enable_budget %>
        <th></th>
        <th>
          <%=@group.currency_symbol%><%= @group.memberships.pluck(:paid).compact.sum %>
          (<%=@group.currency_symbol%><%= @group.processed_via_stripe %> processed via Autopia)
        </th>
      <% end %>
      <% if @group.facebook_group_url %>
        <th></th>
      <% end %>        
      <% if admin? || @membership.admin %>
        <th></th>
      <% end %>                 
    </tr>
  </table>

  <div style="text-align: center">
    <%= will_paginate @memberships, :renderer => WillPaginate::ViewHelpers::BootstrapRenderer %>
  </div>

<% end %>