
<h1><%= @account.persisted? ? 'Edit profile' : 'Sign up' %></h1>

<div class="container">

  <% form_for @account, @account.new_record? ? '/accounts/new' : '/accounts/edit', :multipart => true do |f| %>
    <%= hidden_field_tag :h, :value => params[:h] %>
    <%= f.text_block :name %>
    <%= f.text_block :email %>
    <%= f.password_block :password %>
    <% if @account.persisted? %>
      <%= f.image_block :picture, rotate: false %>
      <%= f.url_block :facebook_profile_url %>
      <%= f.date_block :date_of_birth %>
      <%= f.select_block :gender %>
      <%= f.select_block :time_zone %>
      <%= f.text_block :dietary_requirements %>
      <%= f.check_box_block :unsubscribed %>
    <% end %>
    <%= f.submit_block %>  
  <% end %>

  <% if @account.new_record? %>
    <p class="mt-2">
      Already have an account? <a href="/accounts/sign_in">Sign in</a>
    </p>
  <% end %>

  <script>
    $(function () {
      $('.use-picture').popover({trigger: 'hover', html: true});
    });
  </script>

  <table class="table mt-3">
    <% Provider.registered.each { |provider| %>
      <% if @account.persisted? or (session['omniauth.auth'] and session['omniauth.auth']['provider'] == provider.omniauth_name) %>
        <tr>
          <td><%=provider.display_name%></td>
          <td>
            <% if provider_link = @account.provider_links.select { |provider_link| provider_link.provider == provider.display_name }[0] %>
              <a style="margin-top: 5px" target="_blank" href="<%= provider.profile_url.call(provider_link.omniauth_hash) %>"><%=provider.nickname.call(provider_link.omniauth_hash)%></a>
              <% if current_account %>
                <a class="use-picture btn btn-secondary" href="/accounts/use_picture/<%=provider.omniauth_name%>" data-content="<img src='<%=provider.image.call(provider_link.omniauth_hash)%>'>" title="Click to use this picture">Use picture</a>
                <a class="btn btn-secondary" href="/accounts/disconnect/<%=provider.omniauth_name%>">Disconnect</a>
              <% end %>                
            <% else %>
              <span style="margin-top: 5px">Not connected</span>
              <a class="btn btn-secondary" href="/auth/<%=provider.omniauth_name%>">Connect</a>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% } %>   
  </table>

</div>