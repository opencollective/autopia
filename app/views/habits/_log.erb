
<% habits = Habit.where(:account_id.in => @accounts.pluck(:id)).where(public: true).order('o asc') %>

<% @dates.each { |date| %>
  <h3 class="mt-3"><%=date.to_s(:no_year)%></h3>  
  <table class="table">

    <% people_completing_habits_on_this_date = @accounts.where(:id.in => HabitCompletion.where(:habit_id.in => habits.pluck(:id)).where(date: date).pluck(:account_id)) %>
    <% if people_completing_habits_on_this_date.count > 0 %>
      <% people_completing_habits_on_this_date.each { |account| %>
        <tr>
          <td style="width: 1px"><%= partial :'accounts/square', :locals => {:account => account, :width => '50px'} %></td>
          <td>
            <ul class="fa-ul">              
              <% account.habits.where(public: true).order('o asc').each { |habit| %>
                <% if completed = habit.habit_completions.find_by(:date => date) %>
                  <li>
                    <i class="fa fa-li fa-check"></i>
                    <a href="/habits/<%=habit.id%>"><%= habit.name %></a><% if completed.comment %>: <%= completed.comment %><% end %>
                  </li>  
                <% end %>
              <% } %>            
            </ul>
          </td>
        </tr>
      <% } %>
    <% else %>
      <tr colspan="2">
        <td>
          <em>No habits completed on this day</em>
        </td>
      </tr>
    <% end %>
  </table>
<% } %>

