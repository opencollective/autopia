

<% @public_habits = Habit.where(:account_id.in => @group.members.pluck(:id)).where(public: true) %>

<% @dates.each { |date| %>
  <h3 class="mt-3"><%=date.to_s(:no_year)%></h3>  
  <table class="table">

    <% @members_completing_public_habits_on_this_date = @group.members.where(:id.in => HabitCompletion.where(:habit_id.in => @public_habits.pluck(:id)).where(date: date).pluck(:account_id)) %>
    <% if @members_completing_public_habits_on_this_date.count > 0 %>
      <% @members_completing_public_habits_on_this_date.each { |account| %>
        <tr>
          <td style="width: 1px"><%= partial :'accounts/square', :locals => {:account => account, :width => '50px'} %></td>
          <td>
            <ul class="fa-ul">
              <% HabitCompletion.where(:habit_id.in => account.habits.where(public: true).pluck(:id)).where(date: date).each { |habit_completion| %>
                <li><i class="fa fa-li fa-check"></i> <%= habit_completion.habit.name %></li>
                <% } %>           
            </ul>
          </td>
        </tr>
      <% } %>
    <% else %>
      <tr colspan="2">
        <td>
          <em>No habits completed on this day</em>
        </td>
      </tr>
    <% end %>
  </table>
<% } %>

